<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>54.2. Working with Zend_TimeSync</title>
<link rel="stylesheet" href="dbstyle.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
<link rel="start" href="index.html" title="Zend Framework手册 中文版">
<link rel="up" href="zend.timesync.html" title="第 54 章 Zend_TimeSync">
<link rel="prev" href="zend.timesync.html" title="第 54 章 Zend_TimeSync">
<link rel="next" href="zend.tool.framework.html" title="第 55 章 Zend_Tool_Framework">
<link rel="chapter" href="introduction.html" title="第 1 章 Zend Framework简介">
<link rel="chapter" href="zend.acl.html" title="第 2 章 Zend_Acl">
<link rel="chapter" href="zend.amf.html" title="第 3 章 Zend_Amf">
<link rel="chapter" href="zend.application.html" title="第 4 章 Zend_Application">
<link rel="chapter" href="zend.auth.html" title="第 5 章 Zend_Auth">
<link rel="chapter" href="zend.cache.html" title="第 6 章 Zend_Cache">
<link rel="chapter" href="zend.captcha.html" title="第 7 章 Zend_Captcha">
<link rel="chapter" href="zend.codegenerator.html" title="第 8 章 Zend_CodeGenerator">
<link rel="chapter" href="zend.config.html" title="第 9 章 Zend_Config">
<link rel="chapter" href="zend.config.writer.html" title="第 10 章 Zend_Config_Writer">
<link rel="chapter" href="zend.console.getopt.html" title="第 11 章 Zend_Console_Getopt">
<link rel="chapter" href="zend.controller.html" title="第 12 章 Zend_Controller">
<link rel="chapter" href="zend.currency.html" title="第 13 章 Zend_Currency">
<link rel="chapter" href="zend.date.html" title="第 14 章 Zend_Date">
<link rel="chapter" href="zend.db.html" title="第 15 章 Zend_Db">
<link rel="chapter" href="zend.debug.html" title="第 16 章 Zend_Debug">
<link rel="chapter" href="zend.dojo.html" title="第 17 章 Zend_Dojo">
<link rel="chapter" href="zend.dom.html" title="第 18 章 Zend_Dom">
<link rel="chapter" href="zend.exception.html" title="第 19 章 Zend_Exception">
<link rel="chapter" href="zend.feed.html" title="第 20 章 Zend_Feed">
<link rel="chapter" href="zend.file.html" title="第 21 章 Zend_File">
<link rel="chapter" href="zend.filter.html" title="第 22 章 Zend_Filter">
<link rel="chapter" href="zend.form.html" title="第 23 章 Zend_Form">
<link rel="chapter" href="zend.gdata.html" title="第 24 章 Zend_Gdata">
<link rel="chapter" href="zend.http.html" title="第 25 章 Zend_Http">
<link rel="chapter" href="zend.infocard.html" title="第 26 章 Zend_InfoCard">
<link rel="chapter" href="zend.json.html" title="第 27 章 Zend_Json">
<link rel="chapter" href="zend.layout.html" title="第 28 章 Zend_Layout">
<link rel="chapter" href="zend.ldap.html" title="第 29 章 Zend_Ldap">
<link rel="chapter" href="zend.loader.html" title="第 30 章 Zend_Loader">
<link rel="chapter" href="zend.locale.html" title="第 31 章 Zend_Locale">
<link rel="chapter" href="zend.log.html" title="第 32 章 Zend_Log">
<link rel="chapter" href="zend.mail.html" title="第 33 章 Zend_Mail">
<link rel="chapter" href="zend.measure.html" title="第 34 章 Zend_Measure">
<link rel="chapter" href="zend.memory.html" title="第 35 章 Zend_Memory">
<link rel="chapter" href="zend.mime.html" title="第 36 章 Zend_Mime">
<link rel="chapter" href="zend.navigation.html" title="第 37 章 Zend_Navigation">
<link rel="chapter" href="zend.openid.html" title="第 38 章 Zend_OpenId">
<link rel="chapter" href="zend.paginator.html" title="第 39 章 Zend_Paginator">
<link rel="chapter" href="zend.pdf.html" title="第 40 章 Zend_Pdf">
<link rel="chapter" href="zend.progressbar.html" title="第 41 章 Zend_ProgressBar">
<link rel="chapter" href="zend.queue.html" title="第 42 章 Zend_Queue">
<link rel="chapter" href="zend.reflection.html" title="第 43 章 Zend_Reflection">
<link rel="chapter" href="zend.registry.html" title="第 44 章 Zend_Registry">
<link rel="chapter" href="zend.rest.html" title="第 45 章 Zend_Rest">
<link rel="chapter" href="zend.search.lucene.html" title="第 46 章 Zend_Search_Lucene">
<link rel="chapter" href="zend.server.html" title="第 47 章 Zend_Server">
<link rel="chapter" href="zend.service.html" title="第 48 章 Zend_Service">
<link rel="chapter" href="zend.session.html" title="第 49 章 Zend_Session">
<link rel="chapter" href="zend.soap.html" title="第 50 章 Zend_Soap">
<link rel="chapter" href="zend.tag.html" title="第 51 章 Zend_Tag">
<link rel="chapter" href="zend.test.html" title="第 52 章 Zend_Test">
<link rel="chapter" href="zend.text.html" title="第 53 章 Zend_Text">
<link rel="chapter" href="zend.timesync.html" title="第 54 章 Zend_TimeSync">
<link rel="chapter" href="zend.tool.framework.html" title="第 55 章 Zend_Tool_Framework">
<link rel="chapter" href="zend.tool.project.html" title="第 56 章 Zend_Tool_Project">
<link rel="chapter" href="zend.translate.html" title="第 57 章 Zend_Translate">
<link rel="chapter" href="zend.uri.html" title="第 58 章 Zend_Uri">
<link rel="chapter" href="zend.validate.html" title="第 59 章 Zend_Validate">
<link rel="chapter" href="zend.version.html" title="第 60 章 Zend_Version">
<link rel="chapter" href="zend.view.html" title="第 61 章 Zend_View">
<link rel="chapter" href="zend.wildfire.html" title="第 62 章 Zend_Wildfire">
<link rel="chapter" href="zend.xmlrpc.html" title="第 63 章 Zend_XmlRpc">
<link rel="chapter" href="zendx.console.process.unix.html" title="第 64 章 ZendX_Console_Process_Unix">
<link rel="chapter" href="zendx.jquery.html" title="第 65 章 ZendX_JQuery">
<link rel="appendix" href="requirements.html" title="附录 A. 系统需求">
<link rel="appendix" href="coding-standard.html" title="附录 B. Zend Framework 的 PHP 编码标准">
<link rel="appendix" href="doc-standard.html" title="附录 C. Zend Framework Documentation Standard">
<link rel="appendix" href="project-structure.html" title="附录 D. Recommended Project Structure for Zend Framework MVC Applications">
<link rel="appendix" href="performance.html" title="附录 E. Zend Framework Performance Guide">
<link rel="appendix" href="copyrights.html" title="附录 F. 版权信息">
<link rel="index" href="the.index.html" title="索引">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.generic" title="54.2.1. Generic Time Server Request">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.multiple" title="54.2.2. Multiple Time Servers">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.protocol" title="54.2.3. Protocols of Time Servers">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.ports" title="54.2.4. Using Ports for Time Servers">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.options" title="54.2.5. Time Servers Options">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.different" title="54.2.6. Using Different Time Servers">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.informations" title="54.2.7. Information from Time Servers">
<link rel="subsection" href="zend.timesync.working.html#zend.timesync.working.exceptions" title="54.2.8. Handling Exceptions">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader"><table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">54.2. Working with Zend_TimeSync</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="zend.timesync.html">上一页</a> </td>
<th width="60%" align="center">第 54 章 Zend_TimeSync</th>
<td width="20%" align="right"> <a accesskey="n" href="zend.tool.framework.html">下一页</a>
</td>
</tr>
</table></div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="zend.timesync.working"></a>54.2. Working with Zend_TimeSync</h2></div></div></div>
<p>
        <code class="classname">Zend_TimeSync</code> can return the actual time from any given
        <span class="emphasis"><em>NTP</em></span> or <span class="emphasis"><em>SNTP</em></span> time server.
        It can automatically handle multiple servers and provides a simple interface.
    </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"></td>
<th align="left">注意</th>
</tr>
<tr><td align="left" valign="top"><p>
            All examples in this chapter use a public, generic time server: <span class="emphasis"><em>0.europe.pool.ntp.org</em></span>. You should use a public, generic time server which is close to your application server.
            See <a href="http://www.pool.ntp.org" target="_top">http://www.pool.ntp.org</a> for
            information.
        </p></td></tr>
</table></div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.generic"></a>54.2.1. Generic Time Server Request</h3></div></div></div>
<p>
            Requesting the time from a time server is simple. First, you provide the time server
            from which you want to request the time.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync('0.pool.ntp.org');

print $server-&gt;getDate()-&gt;getIso();
</pre>
<p>
            So what is happening in the background of <code class="classname">Zend_TimeSync</code>? First the syntax of the
            time server is checked. In our example, '<code class="code">0.pool.ntp.org</code>' is checked and
            recognised as a possible address for a time server. Then when calling
            <code class="methodname">getDate()</code> the actual set time server is requested and it will return its own
            time. <code class="classname">Zend_TimeSync</code> then calculates the difference to the actual time of the
            server running the script and returns a <code class="classname">Zend_Date</code> object with the
            correct time.
        </p>
<p>
            For details about <code class="classname">Zend_Date</code> and its methods see the
            <a href="zend.date.html#zend.date.introduction" title="14.1.  简介"><code class="classname">Zend_Date</code> documentation</a>.
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.multiple"></a>54.2.2. Multiple Time Servers</h3></div></div></div>
<p>
            Not all time servers are always available to return their time. Servers may be unavailable during maintenance, for example.
            When the time cannot be requested from the time server, you will get an exception.
        </p>
<p>
            <code class="classname">Zend_TimeSync</code> is a simple solution that can handle multiple time servers and supports an
            automatic fallback mechanism. There are two supported ways; you can either specify an array
            of time servers when creating the instance, or you can add additional time servers to the instance
            using the <code class="methodname">addServer()</code> method.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('0.pool.ntp.org',
                                  '1.pool.ntp.org',
                                  '2.pool.ntp.org'));
$server-&gt;addServer('3.pool.ntp.org');

print $server-&gt;getDate()-&gt;getIso();
</pre>
<p>
            There is no limit to the number of time servers you can add. When a time server can not
            be reached, <code class="classname">Zend_TimeSync</code> will fallback and try to connect to the next time server.
        </p>
<p>
            When you supply more than one time server- which is considered a best practice for <code class="classname">Zend_TimeSync</code>- you should name
            each server. You can name your servers with array keys, with the second
            parameter at instantiation, or with the second parameter when adding another time server.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('generic'  =&gt; '0.pool.ntp.org',
                                  'fallback' =&gt; '1.pool.ntp.org',
                                  'reserve'  =&gt; '2.pool.ntp.org'));
$server-&gt;addServer('3.pool.ntp.org', 'additional');

print $server-&gt;getDate()-&gt;getIso();
</pre>
<p>
            Naming the time servers allows you to request a specific time server as we will see
            later in this chapter.
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.protocol"></a>54.2.3. Protocols of Time Servers</h3></div></div></div>
<p>
            There are different types of time servers. Most public time servers use the
            <span class="emphasis"><em>NTP</em></span> protocol. But there are other time synchronization
            protocols available.
        </p>
<p>
            You set the proper protocol in the address of the time server. There are two
            protocols which are supported by <code class="classname">Zend_TimeSync</code>: <span class="emphasis"><em>NTP</em></span> and <span class="emphasis"><em>SNTP</em></span>. The default protocol is
            <span class="emphasis"><em>NTP</em></span>. If you are using <span class="emphasis"><em>NTP</em></span>, you can omit the protocol
            in the address as demonstrated in the previous examples.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('generic'  =&gt; 'ntp:\\0.pool.ntp.org',
                                  'fallback' =&gt; 'ntp:\\1.pool.ntp.org',
                                  'reserve'  =&gt; 'ntp:\\2.pool.ntp.org'));
$server-&gt;addServer('sntp:\\internal.myserver.com', 'additional');

print $server-&gt;getDate()-&gt;getIso();
</pre>
<p>
            <code class="classname">Zend_TimeSync</code> can handle mixed time servers. So you are not restricted to
            only one protocol; you can add any server independently from its protocol.
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.ports"></a>54.2.4. Using Ports for Time Servers</h3></div></div></div>
<p>
            As with every protocol within the world wide web, the <span class="emphasis"><em>NTP</em></span> and
            <span class="emphasis"><em>SNTP</em></span> protocols use standard ports. NTP uses port
            <span class="emphasis"><em>123</em></span> and SNTP uses port <span class="emphasis"><em>37</em></span>.
        </p>
<p>
            But sometimes the port that the protocols use differs from the standard one. You can define the port which
            has to be used for each server within the address. Just add the number of the port after the
            address. If no port is defined, then <code class="classname">Zend_TimeSync</code> will use the standard port.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('generic'  =&gt; 'ntp:\\0.pool.ntp.org:200',
                                  'fallback' =&gt; 'ntp:\\1.pool.ntp.org'));
$server-&gt;addServer('sntp:\\internal.myserver.com:399', 'additional');

print $server-&gt;getDate()-&gt;getIso();
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.options"></a>54.2.5. Time Servers Options</h3></div></div></div>
<p>
            There is only one option within <code class="classname">Zend_TimeSync</code> which will be used internally: <span class="emphasis"><em>timeout</em></span>.
            You can set any self-defined option you are in need of and request it, however.
        </p>
<p>
            The option <span class="emphasis"><em>timeout</em></span> defines the number of seconds after which
            a connection is detected as broken when there was no response. The default value is
            <span class="emphasis"><em>1</em></span>, which means that <code class="classname">Zend_TimeSync</code> will
            fallback to the next time server if the requested time server does not respond in one second.
        </p>
<p>
            With the <code class="methodname">setOptions()</code> method, you can set any option. This function accepts an array where the
            key is the option to set and the value is the value of that option. Any previously set option will
            be overwritten by the new value. If you want to know which options are set, use the
            <code class="methodname">getOptions()</code> method. It accepts either a key which returns the given option if specified,
            or, if no key is set, it will return all set options.
        </p>
<pre class="programlisting">
Zend_TimeSync::setOptions(array('timeout' =&gt; 3, 'myoption' =&gt; 'timesync'));
$server = new Zend_TimeSync(array('generic'  =&gt; 'ntp:\\0.pool.ntp.org',
                                  'fallback' =&gt; 'ntp:\\1.pool.ntp.org'));
$server-&gt;addServer('sntp:\\internal.myserver.com', 'additional');

print $server-&gt;getDate()-&gt;getIso();
print_r(Zend_TimeSync::getOptions();
print "Timeout = " . Zend_TimeSync::getOptions('timeout');
</pre>
<p>
            As you can see, the options for <code class="classname">Zend_TimeSync</code> are static. Each
            instance of <code class="classname">Zend_TimeSync</code> will use the same options.
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.different"></a>54.2.6. Using Different Time Servers</h3></div></div></div>
<p>
            <code class="classname">Zend_TimeSync</code>'s default behavior for requesting a time is to request it from the first given server.
            But sometimes it is useful to set a different time server from which to request the time.
            This can be done with the <code class="methodname">setServer()</code> method. To define the used time server
            set the alias as a parameter within the method. To get the actual used time server
            call the <code class="methodname">getServer()</code> method. It accepts an alias as a parameter which
            defines the time server to be returned. If no parameter is given, the current time server will
            be returned.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('generic'  =&gt; 'ntp:\\0.pool.ntp.org',
                                  'fallback' =&gt; 'ntp:\\1.pool.ntp.org'));
$server-&gt;addServer('sntp:\\internal.myserver.com', 'additional');

$actual = $server-&gt;getServer();
$server = $server-&gt;setServer('additional');
</pre>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.informations"></a>54.2.7. Information from Time Servers</h3></div></div></div>
<p>
            Time servers not only offer the time itself, but also additional information. You can
            get this information with the <code class="methodname">getInfo()</code> method.
        </p>
<pre class="programlisting">
$server = new Zend_TimeSync(array('generic'  =&gt; 'ntp:\\0.pool.ntp.org',
                                  'fallback' =&gt; 'ntp:\\1.pool.ntp.org'));

print_r ($server-&gt;getInfo());
</pre>
<p>
            The returned information differs with the protocol used and can also differ with the
            server used.
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.timesync.working.exceptions"></a>54.2.8. Handling Exceptions</h3></div></div></div>
<p>
            Exceptions are collected for all time servers and returned as an array. So you can
            iterate through all thrown exceptions as shown in the following example:
        </p>
<pre class="programlisting">
$serverlist = array(
        // invalid servers
        'invalid_a'  =&gt; 'ntp://a.foo.bar.org',
        'invalid_b'  =&gt; 'sntp://b.foo.bar.org',
);

$server = new Zend_TimeSync($serverlist);

try {
    $result = $server-&gt;getDate();
    echo $result-&gt;getIso();
} catch (Zend_TimeSync_Exception $e) {

    $exceptions = $e-&gt;get();

    foreach ($exceptions as $key =&gt; $myException) {
        echo $myException-&gt;getMessage();
        echo '&lt;br /&gt;';
    }
}
</pre>
</div>
</div>
<div class="navfooter"><table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="zend.timesync.html">上一页</a> </td>
<td width="20%" align="center"><a accesskey="u" href="zend.timesync.html">上一级</a></td>
<td width="40%" align="right"> <a accesskey="n" href="zend.tool.framework.html">下一页</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">第 54 章 Zend_TimeSync </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td>
<td width="40%" align="right" valign="top"> 第 55 章 Zend_Tool_Framework</td>
</tr>
</table></div>
<div class="revinfo"></div>
</body>
</html>
