<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>5.5. LDAP 认证</title>
<link rel="stylesheet" href="dbstyle.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
<link rel="start" href="index.html" title="Zend Framework手册 中文版">
<link rel="up" href="zend.auth.html" title="第 5 章 Zend_Auth">
<link rel="prev" href="zend.auth.adapter.http.html" title="5.4. HTTP 认证适配器">
<link rel="next" href="zend.auth.adapter.openid.html" title="5.6. Open ID Authentication">
<link rel="chapter" href="introduction.html" title="第 1 章 Zend Framework简介">
<link rel="chapter" href="zend.acl.html" title="第 2 章 Zend_Acl">
<link rel="chapter" href="zend.amf.html" title="第 3 章 Zend_Amf">
<link rel="chapter" href="zend.application.html" title="第 4 章 Zend_Application">
<link rel="chapter" href="zend.auth.html" title="第 5 章 Zend_Auth">
<link rel="chapter" href="zend.cache.html" title="第 6 章 Zend_Cache">
<link rel="chapter" href="zend.captcha.html" title="第 7 章 Zend_Captcha">
<link rel="chapter" href="zend.codegenerator.html" title="第 8 章 Zend_CodeGenerator">
<link rel="chapter" href="zend.config.html" title="第 9 章 Zend_Config">
<link rel="chapter" href="zend.config.writer.html" title="第 10 章 Zend_Config_Writer">
<link rel="chapter" href="zend.console.getopt.html" title="第 11 章 Zend_Console_Getopt">
<link rel="chapter" href="zend.controller.html" title="第 12 章 Zend_Controller">
<link rel="chapter" href="zend.currency.html" title="第 13 章 Zend_Currency">
<link rel="chapter" href="zend.date.html" title="第 14 章 Zend_Date">
<link rel="chapter" href="zend.db.html" title="第 15 章 Zend_Db">
<link rel="chapter" href="zend.debug.html" title="第 16 章 Zend_Debug">
<link rel="chapter" href="zend.dojo.html" title="第 17 章 Zend_Dojo">
<link rel="chapter" href="zend.dom.html" title="第 18 章 Zend_Dom">
<link rel="chapter" href="zend.exception.html" title="第 19 章 Zend_Exception">
<link rel="chapter" href="zend.feed.html" title="第 20 章 Zend_Feed">
<link rel="chapter" href="zend.file.html" title="第 21 章 Zend_File">
<link rel="chapter" href="zend.filter.html" title="第 22 章 Zend_Filter">
<link rel="chapter" href="zend.form.html" title="第 23 章 Zend_Form">
<link rel="chapter" href="zend.gdata.html" title="第 24 章 Zend_Gdata">
<link rel="chapter" href="zend.http.html" title="第 25 章 Zend_Http">
<link rel="chapter" href="zend.infocard.html" title="第 26 章 Zend_InfoCard">
<link rel="chapter" href="zend.json.html" title="第 27 章 Zend_Json">
<link rel="chapter" href="zend.layout.html" title="第 28 章 Zend_Layout">
<link rel="chapter" href="zend.ldap.html" title="第 29 章 Zend_Ldap">
<link rel="chapter" href="zend.loader.html" title="第 30 章 Zend_Loader">
<link rel="chapter" href="zend.locale.html" title="第 31 章 Zend_Locale">
<link rel="chapter" href="zend.log.html" title="第 32 章 Zend_Log">
<link rel="chapter" href="zend.mail.html" title="第 33 章 Zend_Mail">
<link rel="chapter" href="zend.measure.html" title="第 34 章 Zend_Measure">
<link rel="chapter" href="zend.memory.html" title="第 35 章 Zend_Memory">
<link rel="chapter" href="zend.mime.html" title="第 36 章 Zend_Mime">
<link rel="chapter" href="zend.navigation.html" title="第 37 章 Zend_Navigation">
<link rel="chapter" href="zend.openid.html" title="第 38 章 Zend_OpenId">
<link rel="chapter" href="zend.paginator.html" title="第 39 章 Zend_Paginator">
<link rel="chapter" href="zend.pdf.html" title="第 40 章 Zend_Pdf">
<link rel="chapter" href="zend.progressbar.html" title="第 41 章 Zend_ProgressBar">
<link rel="chapter" href="zend.queue.html" title="第 42 章 Zend_Queue">
<link rel="chapter" href="zend.reflection.html" title="第 43 章 Zend_Reflection">
<link rel="chapter" href="zend.registry.html" title="第 44 章 Zend_Registry">
<link rel="chapter" href="zend.rest.html" title="第 45 章 Zend_Rest">
<link rel="chapter" href="zend.search.lucene.html" title="第 46 章 Zend_Search_Lucene">
<link rel="chapter" href="zend.server.html" title="第 47 章 Zend_Server">
<link rel="chapter" href="zend.service.html" title="第 48 章 Zend_Service">
<link rel="chapter" href="zend.session.html" title="第 49 章 Zend_Session">
<link rel="chapter" href="zend.soap.html" title="第 50 章 Zend_Soap">
<link rel="chapter" href="zend.tag.html" title="第 51 章 Zend_Tag">
<link rel="chapter" href="zend.test.html" title="第 52 章 Zend_Test">
<link rel="chapter" href="zend.text.html" title="第 53 章 Zend_Text">
<link rel="chapter" href="zend.timesync.html" title="第 54 章 Zend_TimeSync">
<link rel="chapter" href="zend.tool.framework.html" title="第 55 章 Zend_Tool_Framework">
<link rel="chapter" href="zend.tool.project.html" title="第 56 章 Zend_Tool_Project">
<link rel="chapter" href="zend.translate.html" title="第 57 章 Zend_Translate">
<link rel="chapter" href="zend.uri.html" title="第 58 章 Zend_Uri">
<link rel="chapter" href="zend.validate.html" title="第 59 章 Zend_Validate">
<link rel="chapter" href="zend.version.html" title="第 60 章 Zend_Version">
<link rel="chapter" href="zend.view.html" title="第 61 章 Zend_View">
<link rel="chapter" href="zend.wildfire.html" title="第 62 章 Zend_Wildfire">
<link rel="chapter" href="zend.xmlrpc.html" title="第 63 章 Zend_XmlRpc">
<link rel="chapter" href="zendx.console.process.unix.html" title="第 64 章 ZendX_Console_Process_Unix">
<link rel="chapter" href="zendx.jquery.html" title="第 65 章 ZendX_JQuery">
<link rel="appendix" href="requirements.html" title="附录 A. 系统需求">
<link rel="appendix" href="coding-standard.html" title="附录 B. Zend Framework 的 PHP 编码标准">
<link rel="appendix" href="doc-standard.html" title="附录 C. Zend Framework Documentation Standard">
<link rel="appendix" href="project-structure.html" title="附录 D. Recommended Project Structure for Zend Framework MVC Applications">
<link rel="appendix" href="performance.html" title="附录 E. Zend Framework Performance Guide">
<link rel="appendix" href="copyrights.html" title="附录 F. 版权信息">
<link rel="index" href="the.index.html" title="索引">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.introduction" title="5.5.1.  简介">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.usage" title="5.5.2.  用法">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.api" title="5.5.3. The API">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.server-options" title="5.5.4.  服务器选项">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.debugging" title="5.5.5.  收集调试信息">
<link rel="subsection" href="zend.auth.adapter.ldap.html#zend.auth.adapter.ldap.options-common-server-specific" title="5.5.6.  特定服务器的通用选项">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader"><table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">5.5. LDAP 认证 </th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="zend.auth.adapter.http.html">上一页</a> </td>
<th width="60%" align="center">第 5 章 Zend_Auth</th>
<td width="20%" align="right"> <a accesskey="n" href="zend.auth.adapter.openid.html">下一页</a>
</td>
</tr>
</table></div>
<div class="sect1" lang="zh-cn">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="zend.auth.adapter.ldap"></a>5.5. LDAP 认证 </h2></div></div></div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.introduction"></a>5.5.1.  简介 </h3></div></div></div>
<p>
            <code class="code">Zend_Auth_Adapter_Ldap</code> 用 LDAP 服务支持 web 程序认证。它的功能包括用户名和域名规范化、多域认证和实效切（failover）换能力。经测试，它能与  <a href="http://www.microsoft.com/windowsserver2003/technologies/directory/activedirectory/" target="_top">Microsoft Active Directory</a> 和 <a href="http://www.openldap.org/" target="_top">OpenLDAP</a> 一起工作，它也应该能和其它 LDAP 服务提供者一起工作。
        </p>
<p>
            本文档包括使用 <code class="code">Zend_Auth_Adapter_Ldap</code> 的指南、它的 API 、各种可用选项的大纲、认证问题故障排除的诊断信息和Active Directory 与 OpenLDAP 服务器的范例选项。
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.usage"></a>5.5.2.  用法 </h3></div></div></div>
<p>
            为了快速把 <code class="code">Zend_Auth_Adapter_Ldap</code> 认证集成到你的程序中，即使你不使用 <code class="code">Zend_Controller</code>，代码的基本部分看起来是这样的：
            </p>
<pre class="programlisting">
$username = $this-&gt;_request-&gt;getParam('username');
$password = $this-&gt;_request-&gt;getParam('password');

$auth = Zend_Auth::getInstance();

$config = new Zend_Config_Ini('../application/config/config.ini',
                              'production');
$log_path = $config-&gt;ldap-&gt;log_path;
$options = $config-&gt;ldap-&gt;toArray();
unset($options['log_path']);

$adapter = new Zend_Auth_Adapter_Ldap($options, $username,
                                      $password);

$result = $auth-&gt;authenticate($adapter);

if ($log_path) {
    $messages = $result-&gt;getMessages();

    $logger = new Zend_Log();
    $logger-&gt;addWriter(new Zend_Log_Writer_Stream($log_path));
    $filter = new Zend_Log_Filter_Priority(Zend_Log::DEBUG);
    $logger-&gt;addFilter($filter);

    foreach ($messages as $i =&gt; $message) {
        if ($i-- &gt; 1) { // $messages[2] and up are log messages
            $message = str_replace("\n", "\n  ", $message);
            $logger-&gt;log("Ldap: $i: $message", Zend_Log::DEBUG);
        }
    }
}

            </pre>
<p>
            虽然日志（ logging ）代码是可选的，还是强烈建议使用日志。<code class="code">Zend_Auth_Adapter_Ldap</code> 将记录任何想要的信息细节到 <code class="code">$messages</code> （更多的信息看下面），对于难以调试的程序来说，有历史记录这是个很好的功能。
        </p>
<p>
            上面用到 <code class="code">Zend_Config_Ini</code> 的代码是来加载适配器选项，它也是可选的，使用一个规则的数组来完成工作。下面是带有两个单独的服务器选项的 <code class="code">application/config/config.ini</code> 文件的例子。带有多组服务器选项的适配器将按顺序来尝试每个服务器直到资格被成功认证。服务器的名字 （例如 <code class="code">server1</code> and <code class="code">server2</code>）是任意的，关于选项数组的细节，参见下面 <span class="emphasis"><em>Server Options</em></span> 一节。 注意 <code class="code">Zend_Config_Ini</code> 要求任何带有等号（<code class="code">=</code>）的值需要括起来（如下面的 DNs）。
            </p>
<pre class="programlisting">
[production]

ldap.log_path = /tmp/ldap.log

; Typical options for OpenLDAP
ldap.server1.host = s0.foo.net
ldap.server1.accountDomainName = foo.net
ldap.server1.accountDomainNameShort = FOO
ldap.server1.accountCanonicalForm = 3
ldap.server1.username = "CN=user1,DC=foo,DC=net"
ldap.server1.password = pass1
ldap.server1.baseDn = "OU=Sales,DC=foo,DC=net"
ldap.server1.bindRequiresDn = true

; Typical options for Active Directory
ldap.server2.host = dc1.w.net
ldap.server2.useSsl = true
ldap.server2.accountDomainName = w.net
ldap.server2.accountDomainNameShort = W
ldap.server2.accountCanonicalForm = 3
ldap.server2.baseDn = "CN=Users,DC=w,DC=net"

</pre>
<p>
            上述的配置将指示 <code class="code">Zend_Auth_Adapter_Ldap</code> 首先来尝试用 OpenLDAP 服务器 <code class="code">s0.foo.net</code> 来认证用户，如果不论什么原因认证失败，将尝试 AD 服务器 <code class="code">dc1.w.net</code>。
        </p>
<p>
            这个配置示例了在不同的域的服务器的多域认证，也可以在同一域中用多个服务器来提供冗余。
        </p>
<p>
            注意在这个例子中，即使 OpenLDAP 不需要用于 Windows 的短 NetBIOS 风格的域名，我们仍在这里提供它以保证命名正规化 （参见下面的 <span class="emphasis"><em>Username Canonicalization</em></span> 一节）。
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.api"></a>5.5.3. The API</h3></div></div></div>
<p>
            <code class="code">Zend_Auth_Adapter_Ldap</code> 构造器接受三个参数。
        </p>
<p>
            <code class="code">$options</code> 参数是必需的并且是一个包含一组或多组选项的数组。注意它是 <a href="zend.ldap.html" title="第 29 章 Zend_Ldap">Zend_Ldap</a> 选项的 <span class="emphasis"><em> 数组的数组 </em></span> 。即使你只使用一个 LDAP 服务器，选项仍要包含在另一个数组中。
        </p>
<p>
            下面是一个选项参数包含两组服务器选项（ <code class="code">s0.foo.net</code> 和 <code class="code">dc1.w.net</code> （和上面 INI 表示法一样的选项））的例子的 <a href="http://php.net/print_r" target="_top"><code class="code">print_r()</code></a> 输出：
            </p>
<pre class="programlisting">
Array
(
    [server2] =&gt; Array
        (
            [host] =&gt; dc1.w.net
            [useSsl] =&gt; 1
            [accountDomainName] =&gt; w.net
            [accountDomainNameShort] =&gt; W
            [accountCanonicalForm] =&gt; 3
            [baseDn] =&gt; CN=Users,DC=w,DC=net
        )

    [server1] =&gt; Array
        (
            [host] =&gt; s0.foo.net
            [accountDomainName] =&gt; foo.net
            [accountDomainNameShort] =&gt; FOO
            [accountCanonicalForm] =&gt; 3
            [username] =&gt; CN=user1,DC=foo,DC=net
            [password] =&gt; pass1
            [baseDn] =&gt; OU=Sales,DC=foo,DC=net
            [bindRequiresDn] =&gt; 1
        )

)

</pre>
<p>
            上述每组选项提供的信息是不同的，主要是因为当绑定（参见下面 <span class="emphasis"><em> 服务器选项 </em></span> 一节中的 <code class="code">bindRequiresDn</code> 选项）时 AD 不要求在 DN 表单中的有用户名，这意味着我们可以忽略很多和为认证用户名获取 DN 相关的选项。
        </p>
<div class="note"><table border="0" summary="Note:  什么是 DN?">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"></td>
<th align="left"> 什么是 DN?</th>
</tr>
<tr><td align="left" valign="top"><p>
                DN 或者 "distinguished name" 是一个字符串，表示在 LDAP 目录中到一个对象的路径。每个用逗号分隔的组件是一个属性并且它的值表示一个节点。组件是按反顺序来算的，例如：用户账户 <span class="emphasis"><em>CN=Bob Carter,CN=Users,DC=w,DC=net</em></span> 直接位于 <span class="emphasis"><em>CN=Users,DC=w,DC=net container</em></span> 里的。这种结构用 LDAP 浏览器如 ADSI Edit MMC snap-in for Active Directory 或 phpLDAPadmin 可以最好地浏览。
            </p></td></tr>
</table></div>
<p>
            服务器名（如上面的 '<code class="code">server1</code>' 和 '<code class="code">server2</code>'）是任意的，但因为使用 <code class="code">Zend_Config</code>，标识符（identifiers）应当以数字索引的相反出现并且不应当包含任何用于相关文件格式（例如，'<code class="code">.</code>' INI 属性分隔符，XML 条目参考 '<code class="code">&amp;</code>' 等）的特殊字符。
        </p>
<p>
            用多组服务器选项，适配器可以在多域的环境中认证用户并提供 failover （估计是失败后尝试下一个服务器），所以如果一个服务器不可用，将查询另一个。
        </p>
<div class="note"><table border="0" summary="Note:  非常详细的介绍 （The Gory Details）－ 在认证方法中到底发生了什么？">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"></td>
<th align="left"> 非常详细的介绍 （The Gory Details）－ 在认证方法中到底发生了什么？</th>
</tr>
<tr><td align="left" valign="top"><p>
                当调用 <code class="code">authenticate()</code> 方法，适配器反复把每组服务器选项设置到内部 <code class="code">Zend_Ldap</code> 实例并带用于认证的用户名和密码调用 <code class="code">Zend_Ldap::bind()</code> 方法。<code class="code">Zend_Ldap</code> 类检查用户名是否在域中合格 （例如，有域的组件如 <span class="emphasis"><em>alice@foo.net</em></span> 或 <span class="emphasis"><em>FOO\alice</em></span>）。如果域存在，但它不匹配任何一种服务器的域名（<span class="emphasis"><em>foo.net</em></span> 或 <span class="emphasis"><em>FOO</em></span>），就抛出一个特殊的异常并由 <code class="code">Zend_Auth_Adapter_Ldap</code> 捕捉，这样那个服务器就被忽略并且选择下个服务器选项。如果域名 <span class="emphasis"><em> 确实 </em></span> 匹配，但是如果用户没有提供一个合格的用户名，<code class="code">Zend_Ldap</code> 继续尝试绑定被提供的证书（credentials）。如果绑定不成功，<code class="code">Zend_Ldap</code> 抛出一个由 <code class="code">Zend_Auth_Adapter_Ldap</code> 捕捉的 <code class="code">Zend_Ldap_Exception</code> 并尝试下一组服务器选项。如果绑定成功，反复尝试（迭代？(iteration)）就停止，并且适配器的 <code class="code">authenticate()</code> 方法返回一个成功的结果。如果所有服务器选项都试过了而且都不成功，认证就失败了，<code class="code">authenticate()</code> 返回一个失败的结果并带有最后一个尝试的错误消息。
            </p></td></tr>
</table></div>
<p>
            <code class="code">Zend_Auth_Adapter_Ldap</code> 构造器的用户名和密码参数是要被认证的证书（例如，用户通过 HTML 登录表单提供的证书（credentials））。另外，也可以通过 <code class="code">setUsername()</code> 和 <code class="code">setPassword()</code> 方法来设置。
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.server-options"></a>5.5.4.  服务器选项 </h3></div></div></div>
<p>
            <span class="emphasis"><em> 在 Zend_Auth_Adapter_Ldap 的上下文中</em></span> 的每组服务器选项包含下列选项，它们基本上不可修改地传递给 <code class="code">Zend_Ldap::setOptions()</code>：

            </p>
<div class="table">
<a name="zend.auth.adapter.ldap.server-options.table"></a><p class="title"><b>表 5.2.  服务器选项 </b></p>
<div class="table-contents"><table summary=" 服务器选项 " border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th> 名称 </th>
<th> 描述 </th>
</tr></thead>
<tbody>
<tr>
<td><span class="strong"><strong>host</strong></span></td>
<td>
                        这些选项表示的 LDAP 服务器的主机名，该选项是必需的。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>port</strong></span></td>
<td>
                        LDAP 服务器监听的端口，如果 <span class="strong"><strong>useSsl</strong></span> 是 <code class="code">true</code>，缺省 <span class="strong"><strong> 端口 </strong></span> 值是 636。如果 <span class="strong"><strong>useSsl</strong></span> 是 <code class="code">false</code>，缺省 <span class="strong"><strong> 端口 </strong></span> 值是 389。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>useSsl</strong></span></td>
<td>
                        如果是 <code class="code">true</code>，表示 LDAP 客户端应当使用 SSL / TLS 加密传输。在生产环境中强烈建议使用 <code class="code">true</code> 值以防止明文传输密码。缺省值为 <code class="code">false</code> 是因为服务器经常在安装之后请求被分别安装的证书。它也改变缺省 <span class="strong"><strong> 端口 </strong></span> 值（ 见上面 <span class="strong"><strong> 端口 </strong></span> 的描述）。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>username</strong></span></td>
<td>
                        账户的 DN， 用来执行账户 DN 查找。LDAP servers that require the username to be in DN form when performing the "bind" require this option （这句没有理解）。
                        如果 <span class="strong"><strong>bindRequiresDn</strong></span> 是 <code class="code">true</code>，这个选项是必需的。这个账户不需要是优先账户 － a account with read-only
                        access to objects under the <span class="strong"><strong>baseDn</strong></span> is all that is necessary (and preferred based on the <span class="emphasis"><em>Principle of Least Privilege</em></span>).
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>password</strong></span></td>
<td>
                        账户的密码，用来执行账户 DN 查找。如果没有提供这个选项，当执行账户 DN 查找时，LDAP 客户端将尝试“匿名绑定”。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>bindRequiresDn</strong></span></td>
<td>
                        一些 LDAP 服务器要求用户名以 DN 格式来绑定，如 <span class="emphasis"><em>CN=Alice Baker,OU=Sales,DC=foo,DC=net</em></span> （基本上 <span class="emphasis"><em> 除了 </em></span> AD 以外所有的服务器）。如果这个选项是 <code class="code">true</code>，<code class="code">Zend_Ldap</code> 自动获取被认证的用户所对应的 DN。如果它不是 DN 格式，那就重新绑定合适的 DN。缺省值是 <code class="code">false</code>。目前，当绑定时，只有微软的 Active Directory 服务器（ADS）<span class="emphasis"><em> 不 </em></span> 要求用户名为 DN 格式，所以和 AD 一起使用，这个选项可以是 <code class="code">false</code> （而且应当是，因为获取 DN 需要额外的过程（round trip）到服务器），否则，这个选项必需设置为  <code class="code">true</code> （例如，OpenLDAP）。当搜索账户时，这个选项也控制缺省的 <span class="strong"><strong>acountFilterFormat</strong></span>，参见 <span class="strong"><strong>accountFilterFormat</strong></span> 选项。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>baseDn</strong></span></td>
<td>
                        定位所有被认证账户下的 DN，这个选项是必需的。如果你不能确定正确的 <span class="strong"><strong>baseDn</strong></span> 值，可以用 <span class="emphasis"><em>DC=</em></span> 组件从用户的 DNS 域来产生它，例如，如果用户的基本名是 <span class="emphasis"><em>alice@foo.net</em></span>，<span class="emphasis"><em>DC=foo,DC=net</em></span> 的 <span class="strong"><strong>baseDn</strong></span> 应当工作。然而更精确的位置（例如 <span class="emphasis"><em>OU=Sales,DC=foo,DC=net</em></span> ）将更有效。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>accountCanonicalForm</strong></span></td>
<td>
                        一个是 2、3 或 4 的值，用来指示那个账户名在成功认证后需要规范化。值的解释具体如下：2 表示传统的用户名（例如 <span class="emphasis"><em>alice</em></span> ），3 表示反斜杠式（backslash-style）名称（例如 <span class="emphasis"><em>FOO\alice</em></span>），或者 4 表示基本式用户名（例如 <span class="emphasis"><em>alice@foo.net</em></span>）。缺省值为 4 （例如 <span class="emphasis"><em>alice@foo.net</em></span> ）。例如，当值为 3，由 <code class="code">Zend_Auth_Result::getIdentity()</code> （如果使用了 <code class="code">Zend_Auth</code>，则是 <code class="code">Zend_Auth::getIdentity()</code>，） 返回的身份（identity）将总是 <span class="emphasis"><em>FOO\alice</em></span>，不论 Alice 提供了什么格式，如 <span class="emphasis"><em>alice</em></span>、 <span class="emphasis"><em>alice@foo.net</em></span>、 <span class="emphasis"><em>FOO\alice</em></span>、<span class="emphasis"><em>FoO\aLicE</em></span>、 <span class="emphasis"><em>foo.net\alice</em></span> 等。见 <code class="code">Zend_Ldap</code> 中的 <span class="emphasis"><em>Account Name Canonicalization</em></span> 一节有更多的细节。注意当使用多组服务器选项时，建议但不要求所有服务器选项使用相同的 <span class="strong"><strong>accountCanonicalForm</strong></span>，这样，用户名对于同一格式总是规范化的（例如，对于 AD 服务器规范化为 <span class="emphasis"><em>EXAMPLE\username</em></span>，但对于 OpenLDAP 服务器规范化为 <span class="emphasis"><em>username@example.com</em></span>，对于程序的高水平（high-level）逻辑，这可能很不好用。）
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainName</strong></span></td>
<td>
                        目标 LDAP 服务器的 FQDN 域名是一个授权（authority）（例如 <code class="code">example.com</code>）。该选项用来规范化名字，这样用户提供的用户名可以为绑定按需转换。它也可用来决定是否服务器对用户名是一个授权（例如 <span class="strong"><strong>accountDomainName</strong></span> 是 <span class="emphasis"><em>foo.net</em></span> 并且用户提供了 <span class="emphasis"><em>bob@bar.net</em></span>，将不查询服务器并导致一个错误）。该选项不是必需的，但如果不提供，那就不支持用户名为基本名（principal name）格式（例如 <span class="emphasis"><em>alice@foo.net</em></span>）。强烈建议使用该选项，因为许多用例要求生成基本名格式。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainNameShort</strong></span></td>
<td>
                        目标 LDAP 服务器的 ‘短’ 域名是一个授权（authority）（例如 <span class="emphasis"><em>FOO</em></span>）。注意按 1:1 来映射 <span class="strong"><strong>accountDomainName</strong></span> 和 <span class="strong"><strong>accountDomainNameShort</strong></span>。该选项用于为 Windows 网络指定 NetBIOS 名但也可用于非 AD 服务器（例如，当多组服务器选用使用反斜杠风格的 <span class="strong"><strong>accountCanonicalForm</strong></span>时为了保持一致性）。该选项不是必需的但如果不使用，就不支持反斜杠格式的用户名（例如 <span class="emphasis"><em>FOO\alice</em></span>）。
                    </td>
</tr>
<tr>
<td><span class="strong"><strong>accountFilterFormat</strong></span></td>
<td>
                        用来搜索账户的 LDAP 搜索过滤器。这个字符串是个 <a href="http://php.net/printf" target="_top"><code class="code">printf()</code></a> 风格的表达式，必需包含一个 '<code class="code">%s</code>' 来适合用户名。缺省值为 '<code class="code">(&amp;(objectClass=user)(sAMAccountName=%s))</code>'，除非 <span class="strong"><strong>bindRequiresDn</strong></span> 设置为 <code class="code">true</code>，那样缺省值就是 '<code class="code">(&amp;(objectClass=posixAccount)(uid=%s))</code>'。例如，如果因为某种原因你想对 AD 使用 <code class="code">bindRequiresDn = true</code> ，需要设置 <code class="code">accountFilterFormat = '(&amp;(objectClass=user)(sAMAccountName=%s))</code>'。
                    </td>
</tr>
</tbody>
</table></div>
</div>
<p><br class="table-break">
        </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"></td>
<th align="left">注意</th>
</tr>
<tr><td align="left" valign="top"><p>
                如果你设置  <code class="code">useSsl = true</code> 可能发现 LDAP 客户端会产生一个不能校验服务器证书的错误。假定 PHP LDAP 扩展完全链接到 OpenLDAP 客户库，为解决这个问题你可以在 OpenLDAP 客户 <code class="code">ldap.conf</code> 里设置 “<code class="code">TLS_REQCERT never</code>” （并重启 web 服务器）来指明 OpenLDAP 客户端库你信任这个服务器。另外如果涉及到服务器可能被欺骗，你可以输出 LDAP 服务器的根证书并把它放到 web 服务器，这样 OpenLDAP 客户端可以校验服务器的身份。
            </p></td></tr>
</table></div>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.debugging"></a>5.5.5.  收集调试信息 </h3></div></div></div>
<p>
            <code class="code">Zend_Auth_Adapter_Ldap</code> 在它的 <code class="code">authenticate()</code> 方法里收集调试信息。这个信息存储在 <code class="code">Zend_Auth_Result</code> 对象里。下面描述由 <code class="code">Zend_Auth_Result::getMessages()</code> 返回的数组：

            </p>
<div class="table">
<a name="zend.auth.adapter.ldap.debugging.table"></a><p class="title"><b>表 5.3.  调试信息 （Messages）</b></p>
<div class="table-contents"><table summary=" 调试信息 （Messages）" border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th> 信息（Messages） 数组索引</th>
<th> 描述 </th>
</tr></thead>
<tbody>
<tr>
<td>Index 0</td>
<td>
                        显示给用户的用户友好的一般信息（例如无效的证书（credentials））。如果认证成功，这个字符串是空的。
                    </td>
</tr>
<tr>
<td>Index 1</td>
<td>
                        更详细的错误信息，不适合显示给用户但作为服务器操错日志。如果认证成功，这个字符串是空的。
                    </td>
</tr>
<tr>
<td>Indexes 2 and higher</td>
<td>
                        所有日志信息按顺序从 index 2 开始。
                    </td>
</tr>
</tbody>
</table></div>
</div>
<p><br class="table-break">

            实践上，index 0 显示给用户（例如使用 FlashMessenger 助手）， index 1 作为日志，如果收集到调试信息， index 2 和它以后的 index 也作为日志（尽管最终的信息总是从 index 1 的字符串开始）。
        </p>
</div>
<div class="sect2" lang="zh-cn">
<div class="titlepage"><div><div><h3 class="title">
<a name="zend.auth.adapter.ldap.options-common-server-specific"></a>5.5.6.  特定服务器的通用选项 </h3></div></div></div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="zend.auth.adapter.ldap.options-common-server-specific.active-directory"></a>5.5.6.1. Active Directory 的选项 </h4></div></div></div>
<p>
                对于 ADS，下列选项值得注意：

                </p>
<div class="table">
<a name="zend.auth.adapter.ldap.options-common-server-specific.active-directory.table"></a><p class="title"><b>表 5.4. Active Directory 的选项 </b></p>
<div class="table-contents"><table summary="Active Directory 的选项 " border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th> 名字 </th>
<th> 另外的注释 </th>
</tr></thead>
<tbody>
<tr>
<td><span class="strong"><strong>host</strong></span></td>
<td>
                            适用所有的服务器，该选项必需。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>useSsl</strong></span></td>
<td>
                            因为安全的缘故，如果服务器安装了必要的证书，这个应该是 <code class="code">true</code>。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>baseDn</strong></span></td>
<td>
                            适用所有的服务器，该选项必需。缺省地 AD 把所有用户账户放在 <span class="emphasis"><em>Users</em></span> 容器中 （例如 <span class="emphasis"><em>CN=Users,DC=foo,DC=net</em></span>），但在大型组织里缺省不常见，要询问 AD 管理员你的程序账户的最好的 DN 是什么。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountCanonicalForm</strong></span></td>
<td>
                            几乎可以确定你想要这个值为 3 来使用反斜杠式的名称（例如 <span class="emphasis"><em>FOO\alice</em></span>），这对于 Windows 用户来说是最熟悉的。你 <span class="emphasis"><em> 不 </em></span> 应该使用不合格的格式 2 （例如 <span class="emphasis"><em>alice</em></span>），因为它可能授权在其它信任域里（例如 <span class="emphasis"><em>BAR\alice</em></span> 和 <span class="emphasis"><em>FOO\alice</em></span> 将被当作相同的用户）相同名字的用户访问你的程序。（参见下面的注释）
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainName</strong></span></td>
<td>
                            使用 AD 时这是必需的除非使用 <span class="strong"><strong>accountCanonicalForm</strong></span> 2 ，再强调一下，我们不鼓励这样用。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainNameShort</strong></span></td>
<td>
                            AD 服务器是授权的域用户的 NetBIOS 名称。如果使用反斜杠风格 <span class="strong"><strong>accountCanonicalForm</strong></span>，这个是必需的。
                        </td>
</tr>
</tbody>
</table></div>
</div>
<p><br class="table-break">
            </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="images/note.png"></td>
<th align="left">注意</th>
</tr>
<tr><td align="left" valign="top"><p>
                    从技术角度讲，用当前的 <code class="code">Zend_Auth_Adapter_Ldap</code> 实现进行跨域认证是没有危险的，因为服务器域是被显式检查的，但对将来的实现未必是对的，如在运行时发现域名或者如果使用替代的适配器（例如 Kerberos）。一般来说，含糊的账户名是安全问题的来源，所以最好使用合格的账户名称。
                </p></td></tr>
</table></div>
</div>
<div class="sect3" lang="zh-cn">
<div class="titlepage"><div><div><h4 class="title">
<a name="zend.auth.adapter.ldap.options-common-server-specific.openldap"></a>5.5.6.2. OpenLDAP 的选项 </h4></div></div></div>
<p>
                对于 OpenLDAP 或一般的使用典型的 posixAccount 风格的 LDAP 服务器，下面的选项值得注意：

                </p>
<div class="table">
<a name="zend.auth.adapter.ldap.options-common-server-specific.openldap.table"></a><p class="title"><b>表 5.5.  OpenLDAP 的选项 </b></p>
<div class="table-contents"><table summary=" OpenLDAP 的选项 " border="1">
<colgroup>
<col>
<col>
</colgroup>
<thead><tr>
<th> 名字 </th>
<th> 另外的注释 </th>
</tr></thead>
<tbody>
<tr>
<td><span class="strong"><strong>host</strong></span></td>
<td>
                            适用所有的服务器，该选项必需。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>useSsl</strong></span></td>
<td>
                            因为安全的缘故，如果服务器安装了必要的证书，这个应该是 <code class="code">true</code>。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>username</strong></span></td>
<td>
                            必需并一定是一个 DN，因为当执行绑定时 OpenLDAP 要求 DN 格式的用户名。设法使用无特权的账户。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>password</strong></span></td>
<td>
                            对应上述用户名的密码，如果 LDAP 服务器支持匿名绑定，这个也许会忽略。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>bindRequiresDn</strong></span></td>
<td>
                            必需并一定是 <code class="code">true</code>，因为当执行绑定时 OpenLDAP 要求 DN 格式的用户名。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>baseDn</strong></span></td>
<td>
                            适用所有的服务器，该选项是必需的并指示所有被认证的账户的 DN 的定位。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountCanonicalForm</strong></span></td>
<td>
                            可选但缺省值是 4 （基本风格名如 <span class="emphasis"><em>alice@foo.net</em></span>），如果适用反斜杠式的名字（如 <span class="emphasis"><em>FOO\alice</em></span>）这个也许不是理想的。对于反斜杠式名字值为 3。
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainName</strong></span></td>
<td>
                            必需，除非使用不推荐的 <span class="strong"><strong>accountCanonicalForm</strong></span> 2，
                        </td>
</tr>
<tr>
<td><span class="strong"><strong>accountDomainNameShort</strong></span></td>
<td>
                            如果不使用 AD ，这个值不是必需的。否则，如果使用 <span class="strong"><strong>accountCanonicalForm</strong></span> 3 ，该选项必需并是个完全对应 <span class="strong"><strong>accountDomainName</strong></span> 的短名 （例如如果 <span class="strong"><strong>accountDomainName</strong></span> 是 <span class="strong"><strong>foo.net</strong></span>，一个好的 <span class="strong"><strong>accountDomainNameShort</strong></span> 值可能是 <span class="emphasis"><em>FOO</em></span>）。
                        </td>
</tr>
</tbody>
</table></div>
</div>
<p><br class="table-break">

            </p>
</div>
</div>
</div>
<div class="navfooter"><table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="zend.auth.adapter.http.html">上一页</a> </td>
<td width="20%" align="center"><a accesskey="u" href="zend.auth.html">上一级</a></td>
<td width="40%" align="right"> <a accesskey="n" href="zend.auth.adapter.openid.html">下一页</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">5.4. HTTP 认证适配器 </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td>
<td width="40%" align="right" valign="top"> 5.6. Open ID Authentication</td>
</tr>
</table></div>
<div class="revinfo"></div>
</body>
</html>
